{% extends 'base.html' %}

{% block title %}Fleet Overview{% endblock %}

{% block content %}
<div class="container py-3">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold"><i class="fas fa-truck me-2"></i>Ambulance Fleet</span>
            <button class="btn btn-sm btn-primary" onclick="openCreateAmbulanceModal()">
                <i class="fas fa-plus me-1"></i>Add Ambulance
            </button>
        </div>
        <div class="card-body">
            <div id="fleetTable">Loading...</div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
async function loadFleet() {
    const res = await fetch('/dispatch/api/ambulances/');
    const data = res.ok ? await res.json() : [];
    const rows = (data||[]).map(a=>`<tr>
        <td>${a.unit_number}</td>
        <td>${a.unit_type_display}</td>
        <td>${a.status_display}</td>
        <td>${a.assigned_paramedic_name||'-'}</td>
        <td>${a.current_emergency_id||'-'}</td>
        <td class="text-end">
            <button class="btn btn-sm btn-outline-secondary me-1" onclick='openEditAmbulanceModal(${JSON.stringify(a).replace(/'/g, "&apos;")})'><i class="fas fa-pen"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteAmbulance(${a.id})"><i class="fas fa-trash"></i></button>
        </td>
    </tr>`).join('');
    document.getElementById('fleetTable').innerHTML = `
        <div class='table-responsive'>
            <table class='table table-striped align-middle'>
                <thead>
                    <tr>
                        <th>Unit</th><th>Type</th><th>Status</th><th>Paramedic</th><th>Call</th><th class='text-end'>Actions</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        </div>`;
}

function openCreateAmbulanceModal() {
    showAmbulanceModal({ id: null, unit_number: '', unit_type: 'BASIC', status: 'AVAILABLE', equipment_list: '', max_patients: 1 });
}

function openEditAmbulanceModal(amb) {
    showAmbulanceModal(amb);
}

function showAmbulanceModal(amb) {
    let modal = document.getElementById('ambulanceModal');
    if (!modal) {
        document.body.insertAdjacentHTML('beforeend', `
        <div class="modal fade" id="ambulanceModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="ambulanceModalTitle">Ambulance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="ambulanceForm">
                  <div class="mb-3">
                    <label class="form-label">Unit Number *</label>
                    <input type="text" class="form-control" name="unit_number" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Unit Type *</label>
                    <select class="form-select" name="unit_type" required>
                      <option value="BASIC">Basic Life Support</option>
                      <option value="ADVANCED">Advanced Life Support</option>
                      <option value="CRITICAL">Critical Care</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Status *</label>
                    <select class="form-select" name="status" required>
                      <option value="AVAILABLE">Available</option>
                      <option value="EN_ROUTE">En Route</option>
                      <option value="ON_SCENE">On Scene</option>
                      <option value="TRANSPORTING">Transporting</option>
                      <option value="MAINTENANCE">Maintenance</option>
                      <option value="OUT_OF_SERVICE">Out of Service</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Max Patients</label>
                    <input type="number" min="1" class="form-control" name="max_patients">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Equipment List</label>
                    <textarea class="form-control" rows="3" name="equipment_list" placeholder="Comma-separated or free text"></textarea>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAmbulanceBtn">Save</button>
              </div>
            </div>
          </div>
        </div>`);
        modal = document.getElementById('ambulanceModal');
    }

    // Populate form
    document.getElementById('ambulanceModalTitle').textContent = amb.id ? `Edit Unit ${amb.unit_number}` : 'Add Ambulance';
    const form = document.getElementById('ambulanceForm');
    form.unit_number.value = amb.unit_number || '';
    form.unit_type.value = amb.unit_type || 'BASIC';
    form.status.value = amb.status || 'AVAILABLE';
    form.max_patients.value = amb.max_patients != null ? amb.max_patients : 1;
    form.equipment_list.value = amb.equipment_list || '';

    const saveBtn = document.getElementById('saveAmbulanceBtn');
    saveBtn.onclick = function() { submitAmbulance(amb.id); };

    new bootstrap.Modal(modal).show();
}

async function submitAmbulance(id) {
    try {
        const form = document.getElementById('ambulanceForm');
        if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
        const data = Object.fromEntries(new FormData(form).entries());
        data.max_patients = parseInt(data.max_patients || '1');

        const url = id ? `/dispatch/api/ambulances/${id}/` : '/dispatch/api/ambulances/';
        const method = id ? 'PATCH' : 'POST';
        const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
            body: JSON.stringify(data)
        });
        if (!res.ok) {
            const err = await res.json().catch(()=>({}));
            throw new Error(err.detail || Object.values(err).join('; ') || 'Failed to save');
        }
        showToast('Ambulance saved', 'success');
        bootstrap.Modal.getInstance(document.getElementById('ambulanceModal')).hide();
        await loadFleet();
    } catch (e) {
        console.error(e);
        showToast(e.message || 'Failed to save ambulance', 'error');
    }
}

async function deleteAmbulance(id) {
    if (!confirm('Delete this ambulance? This cannot be undone.')) return;
    try {
        const res = await fetch(`/dispatch/api/ambulances/${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': getCsrfToken() } });
        if (!res.ok) {
            const err = await res.json().catch(()=>({}));
            throw new Error(err.error || 'Delete failed');
        }
        showToast('Ambulance deleted', 'success');
        await loadFleet();
    } catch (e) {
        console.error(e);
        showToast(e.message || 'Failed to delete ambulance', 'error');
    }
}

document.addEventListener('DOMContentLoaded', loadFleet);
</script>
{% endblock %}
{% endblock %}



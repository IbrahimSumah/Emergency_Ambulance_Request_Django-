{% extends 'base.html' %}
{% load static %}

{% block title %}Ambulance Details - {{ ambulance.unit_number }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Ambulance Unit: {{ ambulance.unit_number }}</h4>
                    <span class="badge badge-{{ ambulance.status|lower }} badge-lg">{{ ambulance.get_status_display }}</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Vehicle Information</h5>
                            <p><strong>Unit Number:</strong> {{ ambulance.unit_number }}</p>
                            <p><strong>Status:</strong> {{ ambulance.get_status_display }}</p>
                            <p><strong>Base Station:</strong> {{ ambulance.base_station }}</p>
                            {% if ambulance.current_location_address %}
                            <p><strong>Current Location:</strong> {{ ambulance.current_location_address }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h5>Assignment</h5>
                            {% if ambulance.assigned_paramedic %}
                            <p><strong>Assigned Paramedic:</strong> {{ ambulance.assigned_paramedic.get_full_name }}</p>
                            {% else %}
                            <p><em>No paramedic assigned</em></p>
                            {% endif %}
                            
                            {% if ambulance.current_call %}
                            <p><strong>Current Call:</strong> 
                                <a href="{% url 'emergencies:call_detail' ambulance.current_call.id %}">
                                    {{ ambulance.current_call.call_id }}
                                </a>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if ambulance.latitude and ambulance.longitude %}
                    <div class="mt-3">
                        <h5>Location Map</h5>
                        <div id="map" style="height: 300px; width: 100%;"></div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Recent Activity</h5>
                </div>
                <div class="card-body">
                    <p><strong>Last Updated:</strong> {{ ambulance.updated_at|date:"M d, Y H:i" }}</p>
                    
                    {% if recent_calls %}
                    <h6>Recent Calls</h6>
                    <ul class="list-unstyled">
                        {% for call in recent_calls %}
                        <li class="mb-2">
                            <a href="{% url 'emergencies:call_detail' call.id %}">{{ call.call_id }}</a>
                            <br><small class="text-muted">{{ call.received_at|date:"M d, H:i" }}</small>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5>Quick Actions</h5>
                </div>
                <div class="card-body">
                    {% if ambulance.status == 'AVAILABLE' %}
                    <button class="btn btn-success btn-block mb-2" onclick="markOutOfService()">Mark Out of Service</button>
                    {% elif ambulance.status == 'OUT_OF_SERVICE' %}
                    <button class="btn btn-primary btn-block mb-2" onclick="markAvailable()">Mark Available</button>
                    {% endif %}
                    
                    <button class="btn btn-info btn-block mb-2" onclick="updateLocation()">Update Location</button>
                    <button class="btn btn-warning btn-block" onclick="viewHistory()">View History</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize map if coordinates are available
{% if ambulance.latitude and ambulance.longitude %}
function initMap() {
    const location = { lat: {{ ambulance.latitude }}, lng: {{ ambulance.longitude }} };
    const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: location,
    });
    const marker = new google.maps.Marker({
        position: location,
        map: map,
        title: "{{ ambulance.unit_number }} Location",
        icon: '/static/images/ambulance-marker.png'
    });
}
{% endif %}

// Quick action functions
function markOutOfService() {
    if (confirm('Mark this ambulance as out of service?')) {
        // AJAX call to update status
        fetch(`/api/ambulances/{{ ambulance.id }}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ status: 'OUT_OF_SERVICE' })
        }).then(() => location.reload());
    }
}

function markAvailable() {
    if (confirm('Mark this ambulance as available?')) {
        fetch(`/api/ambulances/{{ ambulance.id }}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ status: 'AVAILABLE' })
        }).then(() => location.reload());
    }
}
</script>
{% endblock %}

{% extends 'base.html' %}

{% block title %}Dispatcher Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row g-3">
        <!-- Left: Resource Status (Accordion) -->
        <div class="col-lg-4">
            <div class="accordion" id="resourcesAccordion">
                <!-- Calls Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingCalls">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCalls" aria-expanded="true" aria-controls="collapseCalls">
                            <i class="fas fa-phone me-2"></i>Calls
                        </button>
                    </h2>
                    <div id="collapseCalls" class="accordion-collapse collapse show" aria-labelledby="headingCalls" data-bs-parent="#resourcesAccordion">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="btn-group btn-group-sm" role="group" aria-label="Filter calls">
                                    <button type="button" class="btn btn-outline-secondary" data-call-filter="pending">Pending</button>
                                    <button type="button" class="btn btn-outline-secondary" data-call-filter="active">Active</button>
                                    <button type="button" class="btn btn-outline-secondary" data-call-filter="completed">Completed</button>
                                </div>
                                <span id="callsCount" class="badge bg-secondary">0</span>
                            </div>
                            <div id="callsList" class="call-queue"></div>
                        </div>
                    </div>
                </div>
                <!-- Hospitals Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingHospitals">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHospitals" aria-expanded="false" aria-controls="collapseHospitals">
                            <i class="fas fa-hospital me-2"></i>Hospitals
                        </button>
                    </h2>
                    <div id="collapseHospitals" class="accordion-collapse collapse" aria-labelledby="headingHospitals" data-bs-parent="#resourcesAccordion">
                        <div class="accordion-body" id="hospitalsAccordionBody">Loading...</div>
                    </div>
                </div>
                <!-- Fleet Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingFleet">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFleet" aria-expanded="false" aria-controls="collapseFleet">
                            <i class="fas fa-truck me-2"></i>Fleet
                        </button>
                    </h2>
                    <div id="collapseFleet" class="accordion-collapse collapse" aria-labelledby="headingFleet" data-bs-parent="#resourcesAccordion">
                        <div class="accordion-body">
                            <div id="fleetList" class="small">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map: Expanded Center to Right -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-map me-2"></i>Live Map</span>
                    <span id="wsIndicator" class="badge bg-secondary">WS: unknown</span>
                </div>
                <div class="card-body p-0">
                    <div id="map" class="map-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Call Details Modal -->
<div class="modal fade" id="callModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Call Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="callModalBody">Loading...</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Dispatch Modal -->
<div class="modal fade" id="dispatchModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Dispatch Ambulance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="dispatchCallInfo" class="mb-3"></div>
        <form id="dispatchForm">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Select Ambulance *</label>
            <select class="form-select" id="ambulanceSelect" required>
              <option value="">Choose available ambulance...</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Assign Paramedic (Optional)</label>
            <select class="form-select" id="paramedicSelect">
              <option value="">Auto-assign or select...</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="dispatchAmbulance()">Dispatch</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let map, emergencyLayer, ambulanceLayer, ws;
const callsById = new Map();
const ambulancesById = new Map();
let hospitals = [];
let pollingTimer = null;
let currentCallsFilter = 'pending';

function statusBadge(status) {
    const color = {
        RECEIVED: 'danger', DISPATCHED: 'primary', EN_ROUTE: 'info', ON_SCENE: 'danger',
        TRANSPORTING: 'purple', AT_HOSPITAL: 'success', CLOSED: 'secondary'
    }[status] || 'secondary';
    return `<span class="badge bg-${color}">${status.replace('_',' ')}</span>`;
}

function renderCalls(filter) {
    const container = document.getElementById('callsList');
    if (!container) return;
    container.innerHTML = '';
    const values = Array.from(callsById.values());
    const filtered = filter === 'pending' ? values.filter(c=>c.status==='RECEIVED')
                   : filter === 'active' ? values.filter(c=>['DISPATCHED','EN_ROUTE','ON_SCENE','TRANSPORTING'].includes(c.status))
                   : values.filter(c=>['AT_HOSPITAL','CLOSED'].includes(c.status));
    filtered.sort((a,b)=>new Date(b.received_at)-new Date(a.received_at));
    const countEl = document.getElementById('callsCount');
    if (countEl) countEl.textContent = String(filtered.length);
    
    if (filtered.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-inbox me-2"></i>No calls in this category</div>';
        return;
    }
    
    for (const call of filtered) {
        const div = document.createElement('div');
        div.className = 'card mb-2 emergency-card';
        div.style.cursor = 'pointer';
        div.setAttribute('data-call-id', call.id);
        div.innerHTML = `<div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="fw-bold">${call.call_id} â€¢ ${call.emergency_type_display || call.emergency_type}</div>
                    <div class="text-muted small"><i class="fas fa-location-dot me-1"></i>${call.location_address}</div>
                    <div class="text-muted small"><i class="fas fa-clock me-1"></i>${new Date(call.received_at).toLocaleTimeString()}</div>
                </div>
                <div>
                    ${statusBadge(call.status)}
                    ${call.status === 'RECEIVED' ? '<button class="btn btn-sm btn-primary ms-1" onclick="showDispatchModal(' + call.id + ')"><i class="fas fa-truck"></i></button>' : ''}
                </div>
            </div>
        </div>`;
        div.onclick = (e) => {
            if (!e.target.closest('button')) {
                showDispatchModal(call.id);
            }
        };
        container.appendChild(div);
    }
}

function initMap() {
    map = L.map('map').setView([6.5244, 3.3792], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    emergencyLayer = L.markerClusterGroup ? L.markerClusterGroup() : L.layerGroup();
    ambulanceLayer = L.markerClusterGroup ? L.markerClusterGroup() : L.layerGroup();
    map.addLayer(emergencyLayer);
    map.addLayer(ambulanceLayer);
    // Hospital markers layer
    window.hospitalLayer = L.layerGroup().addTo(map);
}

function callMarker(call) {
    const redIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34]
    });
    const m = L.marker([call.latitude || 0, call.longitude || 0], {icon: redIcon}).bindPopup(`
        <div class='small'>
            <div class='fw-bold mb-1'>${call.call_id}</div>
            <div>${call.location_address}</div>
            <div>${statusBadge(call.status)}</div>
        </div>
    `);
    return m;
}

function ambulanceIconForStatus(status) {
    const color = status==='AVAILABLE'?'green':status==='EN_ROUTE'?'blue':status==='ON_SCENE'?'red':'purple';
    const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'>
        <circle cx='16' cy='16' r='12' fill='${color}' />
        <text x='16' y='21' font-size='14' text-anchor='middle' fill='white'>A</text>
    </svg>`);
    return L.icon({ iconUrl: `data:image/svg+xml,${svg}`, iconSize:[32,32], iconAnchor:[16,16] });
}

function renderLayers() {
    emergencyLayer.clearLayers();
    ambulanceLayer.clearLayers();
    if (window.hospitalLayer) window.hospitalLayer.clearLayers();
    for (const call of callsById.values()) {
        if (['RECEIVED','DISPATCHED','EN_ROUTE','ON_SCENE','TRANSPORTING'].includes(call.status)) {
            if (call.latitude && call.longitude) emergencyLayer.addLayer(callMarker(call));
        }
    }
    for (const amb of ambulancesById.values()) {
        if (amb.current_latitude && amb.current_longitude) {
            const marker = L.marker([amb.current_latitude, amb.current_longitude], {icon: ambulanceIconForStatus(amb.status)}).bindPopup(
                `<div class='small'><div class='fw-bold'>Unit ${amb.unit_number}</div><div>Status: ${amb.status_display}</div></div>`
            );
            ambulanceLayer.addLayer(marker);
        }
    }
    // Render hospitals
    if (window.hospitalLayer && hospitals && hospitals.length) {
        hospitals.forEach(h => {
            if (h.latitude && h.longitude) {
                const icon = L.divIcon({ className: 'hospital-icon', html: `<span class='badge bg-dark'>H</span>` });
                const m = L.marker([h.latitude, h.longitude], { icon }).bindPopup(
                    `<div class='small'><div class='fw-bold'>${h.name}</div><div>${h.address||''}</div><div>Capacity: ${h.emergency_capacity_display||h.emergency_capacity}</div></div>`
                );
                window.hospitalLayer.addLayer(m);
            }
        });
    }
}

function focusCall(call) {
    if (call.latitude && call.longitude) {
        map.setView([call.latitude, call.longitude], 14);
    }
    const body = document.getElementById('callModalBody');
    body.innerHTML = `
        <div class='mb-2'><span class='fw-bold me-1'>${call.call_id}</span>${statusBadge(call.status)}</div>
        <div><i class='fas fa-location-dot me-1'></i>${call.location_address}</div>
        <div class='text-muted small'>Type: ${call.emergency_type_display} â€¢ Priority: ${call.priority_display}</div>
    `;
    new bootstrap.Modal(document.getElementById('callModal')).show();
}

function renderFleetList() {
    const el = document.getElementById('fleetList');
    el.innerHTML = '';
    for (const amb of ambulancesById.values()) {
        const color = amb.status==='AVAILABLE'?'success':amb.status==='EN_ROUTE'?'info':amb.status==='ON_SCENE'?'danger':'purple';
        const div = document.createElement('div');
        div.className = 'd-flex justify-content-between align-items-center py-1';
        div.innerHTML = `<span class='fw-semibold'>Unit ${amb.unit_number}</span><span class='badge bg-${color}'>${amb.status_display}</span>`;
        el.appendChild(div);
    }
}

function renderHospitals() {
    const el = document.getElementById('hospitalStatus');
    if (!el) return;
    if (!hospitals || hospitals.length === 0) {
        el.textContent = 'No hospital data';
        return;
    }
    const capacityColor = (cap) => ({
        LOW: 'success',
        MODERATE: 'warning',
        HIGH: 'danger',
        FULL: 'secondary'
    })[cap] || 'secondary';
    el.innerHTML = '';
    hospitals.forEach(h => {
        const div = document.createElement('div');
        div.className = 'd-flex justify-content-between align-items-center py-1';
        const badge = `<span class="badge bg-${capacityColor(h.emergency_capacity)}">${h.emergency_capacity_display || h.emergency_capacity}</span>`;
        const beds = (h.available_beds != null && h.total_beds != null) ? ` <small class="text-muted">(${h.available_beds}/${h.total_beds} beds)</small>` : '';
        div.innerHTML = `<span class='fw-semibold'>${h.name}</span><span>${badge}${beds}</span>`;
        el.appendChild(div);
    });
}

function connectWS() {
    const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
    ws = new WebSocket(`${scheme}://${location.host}/ws/dispatchers/`);
    ws.onopen = () => { updateWsIndicator('connected'); ws.send(JSON.stringify({type:'get_initial_data'})); };
    ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'initial_data') {
            callsById.clear(); ambulancesById.clear();
            for (const c of msg.data.emergencies) callsById.set(c.id, c);
            for (const a of msg.data.ambulances) ambulancesById.set(a.id, a);
            hospitals = msg.data.hospitals || [];
            renderCalls(currentCallsFilter); renderLayers(); renderFleetList(); renderHospitals();
        } else if (msg.type === 'emergency_update') {
            const c = msg.data; callsById.set(c.id, c); renderCalls(currentCallsFilter); renderLayers();
            showToast(`Emergency ${c.call_id}: ${msg.event.replace('_',' ')}`, 'info');
        } else if (msg.type === 'ambulance_update') {
            const a = msg.data; ambulancesById.set(a.id, a); renderLayers(); renderFleetList();
        } else if (msg.type === 'hospital_update') {
            const h = msg.data;
            const idx = hospitals.findIndex(x=>x.id===h.id);
            if (idx>=0) hospitals[idx]=h; else hospitals.push(h);
            renderHospitals(); renderLayers();
        }
    };
    ws.onerror = () => {
        updateWsIndicator('error');
        showToast('WebSocket error', 'warning');
        startPollingFallback();
    };
    ws.onclose = () => {
        updateWsIndicator('closed');
        startPollingFallback();
        setTimeout(connectWS, 10000);
    };
}

let selectedCallId = null;

function showDispatchModal(callId) {
    selectedCallId = callId;
    const call = callsById.get(callId);
    if (!call) return;
    
    // Populate call info
    document.getElementById('dispatchCallInfo').innerHTML = `
        <div class="alert alert-info">
            <strong>${call.call_id}</strong> - ${call.emergency_type_display || call.emergency_type}<br>
            <small><i class="fas fa-location-dot me-1"></i>${call.location_address}</small>
        </div>
    `;
    
    // Populate ambulance options
    const ambulanceSelect = document.getElementById('ambulanceSelect');
    ambulanceSelect.innerHTML = '<option value="">Choose available ambulance...</option>';
    Array.from(ambulancesById.values()).filter(a => a.status === 'AVAILABLE').forEach(amb => {
        ambulanceSelect.innerHTML += `<option value="${amb.id}">Unit ${amb.unit_number} (${amb.unit_type_display || amb.unit_type})</option>`;
    });
    
    // Populate paramedic options
    const paramedicSelect = document.getElementById('paramedicSelect');
    paramedicSelect.innerHTML = '<option value="">Auto-assign or select...</option>';
    fetch('/core/api/paramedics/').then(r=>r.ok?r.json():[]).then(list=>{
        (list||[]).forEach(p=>{
            const name = (p.first_name||'') + ' ' + (p.last_name||'');
            paramedicSelect.innerHTML += `<option value="${p.id}">${name.trim()||p.username}</option>`;
        });
    }).catch(()=>{});

    // Add hospital selector dynamically if not present
    let hospitalSelect = document.getElementById('hospitalSelect');
    if (!hospitalSelect) {
        const form = document.getElementById('dispatchForm');
        const wrapper = document.createElement('div');
        wrapper.className = 'mb-3';
        wrapper.innerHTML = `
            <label class="form-label">Destination Hospital (Optional)</label>
            <select class="form-select" id="hospitalSelect">
                <option value="">Select destination...</option>
            </select>
            <div class="form-text">Filtered by capacity and specialties when available.</div>
        `;
        form.appendChild(wrapper);
        hospitalSelect = document.getElementById('hospitalSelect');
    }
    hospitalSelect.innerHTML = '<option value="">Select destination...</option>';
    (hospitals||[]).forEach(h => {
        hospitalSelect.innerHTML += `<option value="${h.id}">${h.name} (${h.emergency_capacity_display||h.emergency_capacity})</option>`;
    });
    
    new bootstrap.Modal(document.getElementById('dispatchModal')).show();
}

function dispatchAmbulance() {
    const ambulanceId = document.getElementById('ambulanceSelect').value;
    const paramedicId = document.getElementById('paramedicSelect').value;
    const hospitalId = document.getElementById('hospitalSelect') ? document.getElementById('hospitalSelect').value : '';
    
    if (!ambulanceId) {
        showToast('Please select an ambulance', 'error');
        return;
    }
    
    const data = {
        emergency_call_id: selectedCallId,
        ambulance_id: parseInt(ambulanceId),
        paramedic_id: paramedicId ? parseInt(paramedicId) : null
    };
    if (hospitalId) data.hospital_id = parseInt(hospitalId);
    
    fetch('/dispatch/api/dispatch/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    }).then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    }).then(result => {
        showToast('Ambulance dispatched successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('dispatchModal')).hide();
        // Data will be updated via WebSocket
    }).catch(error => {
        console.error('Dispatch error:', error);
        let errorMessage = 'Failed to dispatch ambulance';
        if (error && typeof error === 'object') {
            const errors = [];
            for (const [field, messages] of Object.entries(error)) {
                if (Array.isArray(messages)) {
                    errors.push(`${field}: ${messages.join(', ')}`);
                } else {
                    errors.push(`${field}: ${messages}`);
                }
            }
            if (errors.length > 0) {
                errorMessage = errors.join('; ');
            }
        }
        showToast(errorMessage, 'error');
    });
}

document.addEventListener('DOMContentLoaded', () => {
    initMap();
    connectWS();
    // Calls filter toolbar
    document.querySelectorAll('[data-call-filter]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            document.querySelectorAll('[data-call-filter]').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            currentCallsFilter = btn.dataset.callFilter;
            renderCalls(currentCallsFilter);
        });
    });
    // Apply default filter from server if provided
    try {
        const defaultFilter = '{{ default_filter|default:"pending" }}';
        currentCallsFilter = defaultFilter;
        const btn = document.querySelector(`[data-call-filter="${defaultFilter}"]`) || document.querySelector('[data-call-filter="pending"]');
        if (btn) btn.click(); else renderCalls('pending');
    } catch (e) { renderCalls('pending'); }
    // Enable drop from fleet onto map to pick nearest pending call
    const mapEl = document.getElementById('map');
    mapEl.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    mapEl.addEventListener('drop', (e)=>{
        e.preventDefault();
        const ambIdText = e.dataTransfer.getData('text/plain');
        const ambId = parseInt(ambIdText);
        if (!ambId) return;
        // Get map latlng from event using Leaflet
        const rect = mapEl.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const latlng = map.containerPointToLatLng(L.point(x, y));
        // Find nearest RECEIVED call within ~5km
        let best = null; let bestD = Infinity;
        const toRad = (v)=> v*Math.PI/180;
        const dist = (a,b)=>{
            const R=6371000; const dLat=toRad(b.lat-a.lat); const dLng=toRad(b.lng-a.lng);
            const la=toRad(a.lat); const lb=toRad(b.lat);
            const aa=Math.sin(dLat/2)**2+Math.cos(la)*Math.cos(lb)*Math.sin(dLng/2)**2;
            return 2*R*Math.asin(Math.sqrt(aa));
        };
        callsById.forEach((c)=>{
            if (c.status==='RECEIVED' && c.latitude && c.longitude) {
                const d = dist({lat:latlng.lat,lng:latlng.lng},{lat:c.latitude,lng:c.longitude});
                if (d < bestD) { best = c; bestD = d; }
            }
        });
        if (best && bestD <= 5000) {
            selectedCallId = best.id;
            showDispatchModal(best.id);
            const sel = document.getElementById('ambulanceSelect');
            if (sel) sel.value = String(ambId);
            showToast('Prepared dispatch to nearest call', 'info');
        } else {
            showToast('No nearby pending call found at drop point', 'warning');
        }
    });
});

function updateWsIndicator(state) {
    const el = document.getElementById('wsIndicator');
    if (!el) return;
    const styles = { connected: 'bg-success', error: 'bg-warning', closed: 'bg-danger', unknown: 'bg-secondary' };
    el.className = 'badge ' + (styles[state] || styles.unknown);
    el.textContent = 'WS: ' + state;
}

function startPollingFallback() {
    if (pollingTimer) return;
    showToast('Realtime disabled, switching to periodic updates', 'info');
    const fetchAll = () => {
        Promise.all([
            fetch('/api/emergencies/active/?status=pending').then(r=>r.ok?r.json():[]),
            fetch('/api/emergencies/active/?status=active').then(r=>r.ok?r.json():[]),
            fetch('/api/emergencies/active/?status=completed').then(r=>r.ok?r.json():[]),
            fetch('/dispatch/api/ambulances/').then(r=>r.ok?r.json():[]),
            fetch('/dispatch/api/hospitals/').then(r=>r.ok?r.json():[])
        ]).then(([pending, active, completed, ambulances, hospitalsResp]) => {
            callsById.clear();
            [...(pending||[]), ...(active||[]), ...(completed||[])].forEach(c => callsById.set(c.id, c));
            ambulancesById.clear();
            (ambulances||[]).forEach(a => ambulancesById.set(a.id, a));
            hospitals = hospitalsResp || [];
            renderCalls(currentCallsFilter);
            renderLayers();
            renderFleetList();
            renderHospitals();
        }).catch(() => {});
    };
    fetchAll();
    pollingTimer = setInterval(fetchAll, 10000);
}
</script>
{% endblock %}



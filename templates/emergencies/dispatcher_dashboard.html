{% extends 'base.html' %}

{% block title %}Dispatcher Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row g-3">
        <!-- Left Panel: Call Queue -->
        <div class="col-lg-3">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="fw-bold"><i class="fas fa-list-ul me-2"></i>Call Queue</span>
                    <ul class="nav nav-pills" id="queueTabs">
                        <li class="nav-item"><a class="nav-link active" data-status="pending" href="#">Pending</a></li>
                        <li class="nav-item"><a class="nav-link" data-status="active" href="#">Active</a></li>
                        <li class="nav-item"><a class="nav-link" data-status="transporting" href="#">Transport</a></li>
                    </ul>
                </div>
                <div class="card-body call-queue" id="callQueue"></div>
            </div>
        </div>

        <!-- Center Panel: Live Map -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header fw-bold"><i class="fas fa-map me-2"></i>Live Map</div>
                <div class="card-body p-0">
                    <div id="map" class="map-container"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Resource Status -->
        <div class="col-lg-3">
            <div class="card h-100">
                <div class="card-header fw-bold"><i class="fas fa-hospital me-2"></i>Resource Status</div>
                <div class="card-body resource-status">
                    <div class="mb-3">
                        <h6 class="text-muted">Hospital Status</h6>
                        <div id="hospitalStatus">Loading...</div>
                    </div>
                    <hr>
                    <div>
                        <h6 class="text-muted">Ambulance Fleet</h6>
                        <div id="fleetList" class="small"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Call Details Modal -->
<div class="modal fade" id="callModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Call Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="callModalBody">Loading...</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Dispatch Modal -->
<div class="modal fade" id="dispatchModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Dispatch Ambulance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="dispatchCallInfo" class="mb-3"></div>
        <form id="dispatchForm">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Select Ambulance *</label>
            <select class="form-select" id="ambulanceSelect" required>
              <option value="">Choose available ambulance...</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Assign Paramedic (Optional)</label>
            <select class="form-select" id="paramedicSelect">
              <option value="">Auto-assign or select...</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="dispatchAmbulance()">Dispatch</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let map, emergencyLayer, ambulanceLayer, ws;
const callsById = new Map();
const ambulancesById = new Map();

function statusBadge(status) {
    const color = {
        RECEIVED: 'danger', DISPATCHED: 'primary', EN_ROUTE: 'info', ON_SCENE: 'danger',
        TRANSPORTING: 'purple', AT_HOSPITAL: 'success', CLOSED: 'secondary'
    }[status] || 'secondary';
    return `<span class="badge bg-${color}">${status.replace('_',' ')}</span>`;
}

function renderQueue(filter) {
    const container = document.getElementById('callQueue');
    container.innerHTML = '';
    const values = Array.from(callsById.values());
    const filtered = filter === 'pending' ? values.filter(c=>c.status==='RECEIVED')
                   : filter === 'active' ? values.filter(c=>['DISPATCHED','EN_ROUTE','ON_SCENE'].includes(c.status))
                   : values.filter(c=>c.status==='TRANSPORTING');
    filtered.sort((a,b)=>new Date(b.received_at)-new Date(a.received_at));
    
    if (filtered.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-inbox me-2"></i>No calls in this category</div>';
        return;
    }
    
    for (const call of filtered) {
        const div = document.createElement('div');
        div.className = 'card mb-2 emergency-card';
        div.style.cursor = 'pointer';
        div.setAttribute('data-call-id', call.id);
        div.innerHTML = `<div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="fw-bold">${call.call_id} • ${call.emergency_type_display || call.emergency_type}</div>
                    <div class="text-muted small"><i class="fas fa-location-dot me-1"></i>${call.location_address}</div>
                    <div class="text-muted small"><i class="fas fa-clock me-1"></i>${new Date(call.received_at).toLocaleTimeString()}</div>
                </div>
                <div>
                    ${statusBadge(call.status)}
                    ${call.status === 'RECEIVED' ? '<button class="btn btn-sm btn-primary ms-1" onclick="showDispatchModal(' + call.id + ')"><i class="fas fa-truck"></i></button>' : ''}
                </div>
            </div>
        </div>`;
        div.onclick = (e) => {
            if (!e.target.closest('button')) {
                focusCall(call);
            }
        };
        container.appendChild(div);
    }
}

function initMap() {
    map = L.map('map').setView([6.5244, 3.3792], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    emergencyLayer = L.layerGroup().addTo(map);
    ambulanceLayer = L.layerGroup().addTo(map);
}

function callMarker(call) {
    const redIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34]
    });
    const m = L.marker([call.latitude || 0, call.longitude || 0], {icon: redIcon}).bindPopup(`
        <div class='small'>
            <div class='fw-bold mb-1'>${call.call_id}</div>
            <div>${call.location_address}</div>
            <div>${statusBadge(call.status)}</div>
        </div>
    `);
    return m;
}

function ambulanceIconForStatus(status) {
    const color = status==='AVAILABLE'?'green':status==='EN_ROUTE'?'blue':status==='ON_SCENE'?'red':'purple';
    const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'>
        <circle cx='16' cy='16' r='12' fill='${color}' />
        <text x='16' y='21' font-size='14' text-anchor='middle' fill='white'>A</text>
    </svg>`);
    return L.icon({ iconUrl: `data:image/svg+xml,${svg}`, iconSize:[32,32], iconAnchor:[16,16] });
}

function renderLayers() {
    emergencyLayer.clearLayers();
    ambulanceLayer.clearLayers();
    for (const call of callsById.values()) {
        if (['RECEIVED','DISPATCHED','EN_ROUTE','ON_SCENE','TRANSPORTING'].includes(call.status)) {
            if (call.latitude && call.longitude) emergencyLayer.addLayer(callMarker(call));
        }
    }
    for (const amb of ambulancesById.values()) {
        if (amb.current_latitude && amb.current_longitude) {
            const marker = L.marker([amb.current_latitude, amb.current_longitude], {icon: ambulanceIconForStatus(amb.status)}).bindPopup(
                `<div class='small'><div class='fw-bold'>Unit ${amb.unit_number}</div><div>Status: ${amb.status_display}</div></div>`
            );
            ambulanceLayer.addLayer(marker);
        }
    }
}

function focusCall(call) {
    if (call.latitude && call.longitude) {
        map.setView([call.latitude, call.longitude], 14);
    }
    const body = document.getElementById('callModalBody');
    body.innerHTML = `
        <div class='mb-2'><span class='fw-bold me-1'>${call.call_id}</span>${statusBadge(call.status)}</div>
        <div><i class='fas fa-location-dot me-1'></i>${call.location_address}</div>
        <div class='text-muted small'>Type: ${call.emergency_type_display} • Priority: ${call.priority_display}</div>
    `;
    new bootstrap.Modal(document.getElementById('callModal')).show();
}

function renderFleetList() {
    const el = document.getElementById('fleetList');
    el.innerHTML = '';
    for (const amb of ambulancesById.values()) {
        const color = amb.status==='AVAILABLE'?'success':amb.status==='EN_ROUTE'?'info':amb.status==='ON_SCENE'?'danger':'purple';
        const div = document.createElement('div');
        div.className = 'd-flex justify-content-between align-items-center py-1';
        div.innerHTML = `<span class='fw-semibold'>Unit ${amb.unit_number}</span><span class='badge bg-${color}'>${amb.status_display}</span>`;
        el.appendChild(div);
    }
}

function connectWS() {
    const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
    ws = new WebSocket(`${scheme}://${location.host}/ws/dispatchers/`);
    ws.onopen = () => ws.send(JSON.stringify({type:'get_initial_data'}));
    ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'initial_data') {
            callsById.clear(); ambulancesById.clear();
            for (const c of msg.data.emergencies) callsById.set(c.id, c);
            for (const a of msg.data.ambulances) ambulancesById.set(a.id, a);
            renderQueue('pending'); renderLayers(); renderFleetList();
            document.getElementById('hospitalStatus').textContent = 'Moderate Load';
        } else if (msg.type === 'emergency_update') {
            const c = msg.data; callsById.set(c.id, c); renderQueue('pending'); renderLayers();
            showToast(`Emergency ${c.call_id}: ${msg.event.replace('_',' ')}`, 'info');
        } else if (msg.type === 'ambulance_update') {
            const a = msg.data; ambulancesById.set(a.id, a); renderLayers(); renderFleetList();
        }
    };
    ws.onerror = () => showToast('WebSocket error', 'warning');
    ws.onclose = () => setTimeout(connectWS, 3000);
}

let selectedCallId = null;

function showDispatchModal(callId) {
    selectedCallId = callId;
    const call = callsById.get(callId);
    if (!call) return;
    
    // Populate call info
    document.getElementById('dispatchCallInfo').innerHTML = `
        <div class="alert alert-info">
            <strong>${call.call_id}</strong> - ${call.emergency_type_display || call.emergency_type}<br>
            <small><i class="fas fa-location-dot me-1"></i>${call.location_address}</small>
        </div>
    `;
    
    // Populate ambulance options
    const ambulanceSelect = document.getElementById('ambulanceSelect');
    ambulanceSelect.innerHTML = '<option value="">Choose available ambulance...</option>';
    Array.from(ambulancesById.values()).filter(a => a.status === 'AVAILABLE').forEach(amb => {
        ambulanceSelect.innerHTML += `<option value="${amb.id}">Unit ${amb.unit_number} (${amb.unit_type_display || amb.unit_type})</option>`;
    });
    
    // Populate paramedic options
    const paramedicSelect = document.getElementById('paramedicSelect');
    paramedicSelect.innerHTML = '<option value="">Auto-assign or select...</option>';
    // Note: We'd need to fetch paramedics from API in real implementation
    
    new bootstrap.Modal(document.getElementById('dispatchModal')).show();
}

function dispatchAmbulance() {
    const ambulanceId = document.getElementById('ambulanceSelect').value;
    const paramedicId = document.getElementById('paramedicSelect').value;
    
    if (!ambulanceId) {
        showToast('Please select an ambulance', 'error');
        return;
    }
    
    const data = {
        emergency_call_id: selectedCallId,
        ambulance_id: parseInt(ambulanceId),
        paramedic_id: paramedicId ? parseInt(paramedicId) : null
    };
    
    fetch('/dispatch/api/dispatch/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    }).then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    }).then(result => {
        showToast('Ambulance dispatched successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('dispatchModal')).hide();
        // Data will be updated via WebSocket
    }).catch(error => {
        console.error('Dispatch error:', error);
        let errorMessage = 'Failed to dispatch ambulance';
        if (error && typeof error === 'object') {
            const errors = [];
            for (const [field, messages] of Object.entries(error)) {
                if (Array.isArray(messages)) {
                    errors.push(`${field}: ${messages.join(', ')}`);
                } else {
                    errors.push(`${field}: ${messages}`);
                }
            }
            if (errors.length > 0) {
                errorMessage = errors.join('; ');
            }
        }
        showToast(errorMessage, 'error');
    });
}

document.addEventListener('DOMContentLoaded', () => {
    initMap();
    connectWS();
    document.querySelectorAll('#queueTabs .nav-link').forEach(link=>{
        link.addEventListener('click', (e)=>{
            e.preventDefault();
            document.querySelectorAll('#queueTabs .nav-link').forEach(l=>l.classList.remove('active'));
            link.classList.add('active');
            const s = link.dataset.status;
            renderQueue(s);
        });
    });
});
</script>
{% endblock %}



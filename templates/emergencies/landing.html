{% extends 'base.html' %}

{% block title %}Emergency Ambulance System - Request Ambulance{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="background: linear-gradient(135deg, var(--light-red) 0%, var(--ivory) 100%); min-height: 100vh;">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-11">
            <div class="main-card">
                <!-- Header Section -->
                <div class="header-section text-center">
                    <i class="fas fa-ambulance ambulance-icon"></i>
                    <h1 class="main-title">Emergency Ambulance System</h1>
                    <p class="subtitle">Swift • Reliable • Professional Emergency Response</p>
                </div>
                
                <!-- Form Section -->
                <div class="form-section">
                    <form id="emergencyForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-lg-8 mx-auto">
                                
                                <!-- Emergency Type -->
                                <div class="mb-4">
                                    <label for="emergency_type" class="form-label">
                                        <i class="fas fa-exclamation-triangle text-classical-gold me-2"></i>Emergency Classification
                                    </label>
                                    <select class="form-select form-select-lg" id="emergency_type" name="emergency_type" required>
                                        <option value="">Select emergency type...</option>
                                        <option value="CARDIAC">Cardiac Emergency</option>
                                        <option value="TRAUMA">Trauma Incident</option>
                                        <option value="STROKE">Stroke</option>
                                        <option value="RESPIRATORY">Respiratory Distress</option>
                                        <option value="MEDICAL">Medical Emergency</option>
                                        <option value="FIRE">Fire Emergency</option>
                                        <option value="OTHER">Other Emergency</option>
                                    </select>
                                    <div class="invalid-feedback">Please select an emergency classification.</div>
                                </div>
                                
                                <!-- Location -->
                                <div class="mb-4">
                                    <label for="location_address" class="form-label">
                                        <i class="fas fa-map-marker-alt text-classical-red me-2"></i>Emergency Location
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-lg" id="location_address" 
                                               name="location_address" placeholder="Enter precise address or landmark" required>
                                        <button class="btn btn-outline-classical" type="button" id="getLocationBtn">
                                            <i class="fas fa-crosshairs"></i> Auto-Locate
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">Please provide the emergency location.</div>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <label for="latitude" class="form-label">Latitude</label>
                                            <input type="number" class="form-control" id="latitude" name="latitude" step="0.000001" min="-90" max="90" required>
                                            <div class="invalid-feedback">Please provide a valid latitude (-90 to 90).</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="longitude" class="form-label">Longitude</label>
                                            <input type="number" class="form-control" id="longitude" name="longitude" step="0.000001" min="-180" max="180" required>
                                            <div class="invalid-feedback">Please provide a valid longitude (-180 to 180).</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Caller Information -->
                                <h5 class="section-header">
                                    <i class="fas fa-user me-2"></i>Your Contact Information
                                </h5>
                                <div class="row mb-4">
                                    <div class="col-md-6 mb-3">
                                        <label for="caller_name" class="form-label">Your Name *</label>
                                        <input type="text" class="form-control" id="caller_name" name="caller_name" 
                                               placeholder="Your full name" pattern="[A-Za-z\s]+" 
                                               title="Name should only contain letters and spaces" required>
                                        <div class="invalid-feedback">Please enter your name (letters and spaces only).</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="caller_phone" class="form-label">Your Phone Number *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">+232</span>
                                            <input type="tel" class="form-control" id="caller_phone" name="caller_phone" 
                                                   placeholder="Enter 8-9 digit number" pattern="[0-9]{8,9}" 
                                                   title="Enter 8-9 digit phone number" required>
                                        </div>
                                        <div class="invalid-feedback">Please enter a valid 8-9 digit phone number.</div>
                                        <small class="text-muted">Format: +232 followed by 8-9 digits</small>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info border border-2 border-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note:</strong> Patient details will be collected by our paramedics when they arrive on scene. 
                                    Focus on providing accurate location and emergency information for quick response.
                                </div>
                                
                                <!-- Emergency Description -->
                                <h5 class="section-header">
                                    <i class="fas fa-clipboard-list me-2"></i>Emergency Details
                                </h5>
                                <div class="mb-4">
                                    <label for="description" class="form-label">Incident Description *</label>
                                    <textarea class="form-control" id="description" name="description" rows="4" 
                                              placeholder="Provide detailed information about the emergency situation..." required></textarea>
                                    <div class="invalid-feedback">Please provide a detailed description of the emergency.</div>
                                </div>
                                
                                <!-- Image Upload Section -->
                                <div class="mb-5">
                                    <label class="form-label">
                                        <i class="fas fa-camera me-2"></i>Emergency Photos (Optional)
                                    </label>
                                    <div class="image-upload-container">
                                        <input type="file" id="imageUpload" name="images" multiple accept="image/*" 
                                               class="form-control" style="display: none;">
                                        <div class="upload-area border border-2 border-dashed rounded p-4 text-center" 
                                             id="uploadArea" style="border-color: var(--secondary-red); cursor: pointer;">
                                            <i class="fas fa-cloud-upload-alt text-muted mb-2" style="font-size: 2rem;"></i>
                                            <p class="text-muted mb-2">Click to upload photos or drag and drop</p>
                                            <small class="text-muted">JPEG, PNG, GIF, WebP (Max 5MB each)</small>
                                        </div>
                                        <div id="imagePreview" class="mt-3"></div>
                                        <div id="uploadedImages" class="mt-3"></div>
                                    </div>
                                </div>
                                
                                <!-- Submit Button -->
                                <div class="text-center mb-4">
                                    <button type="submit" class="btn btn-emergency" id="submitBtn">
                                        <i class="fas fa-ambulance me-3"></i>
                                        Dispatch Emergency Response
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Emergency Instructions -->
                    <div class="row mt-5">
                        <div class="col-md-4 mb-4">
                            <div class="info-card">
                                <i class="fas fa-phone-alt info-icon text-classical-red"></i>
                                <h6>Immediate Emergency</h6>
                                <p>For life-threatening situations, call 911 immediately while submitting this form</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="info-card">
                                <i class="fas fa-bolt info-icon text-classical-gold"></i>
                                <h6>Quick Response</h6>
                                <p>Only essential information required - paramedics will collect patient details on scene</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="info-card">
                                <i class="fas fa-clock info-icon text-classical-red"></i>
                                <h6>Rapid Dispatch</h6>
                                <p>Emergency units will be dispatched within minutes of receiving your request</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade modal-classical" id="successModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Emergency Request Confirmed
                </h5>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-ambulance success-icon mb-4"></i>
                <h4 class="text-classical-red mb-3">Request Successfully Submitted</h4>
                <div class="alert alert-light border border-2 border-secondary mb-4">
                    <p class="mb-2"><strong>Emergency ID:</strong> <span id="callId" class="text-classical-red"></span></p>
                    <p class="mb-0"><small class="text-muted">Please save this reference number</small></p>
                </div>
                <p class="text-classical-red"><strong>Emergency response units are being dispatched to your location.</strong></p>
                <p class="mb-0">If you have called 911, please remain on the line with emergency services.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-emergency" data-bs-dismiss="modal">Understood</button>
            </div>
        </div>
    </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('emergencyForm');
    const getLocationBtn = document.getElementById('getLocationBtn');
    const submitBtn = document.getElementById('submitBtn');
    const imageUpload = document.getElementById('imageUpload');
    const uploadArea = document.getElementById('uploadArea');
    const imagePreview = document.getElementById('imagePreview');
    const uploadedImages = document.getElementById('uploadedImages');
    
    let uploadedImageUrls = [];
    
    // Get all form inputs for validation
    const callerNameInput = document.getElementById('caller_name');
    const callerPhoneInput = document.getElementById('caller_phone');
    const emergencyTypeSelect = document.getElementById('emergency_type');
    const locationAddressInput = document.getElementById('location_address');
    const descriptionTextarea = document.getElementById('description');
    
    // Enhanced form validation with real-time feedback
    
    // Name validation - only letters, spaces, hyphens, and apostrophes
    callerNameInput.addEventListener('input', function(e) {
        const value = e.target.value;
        const namePattern = /^[A-Za-z\s\-\']*$/;
        
        if (!namePattern.test(value)) {
            e.target.value = value.replace(/[^A-Za-z\s\-\']/g, '');
        }
        
        // Prevent multiple consecutive spaces
        e.target.value = e.target.value.replace(/\s{2,}/g, ' ');
        
        validateNameField(e.target);
    });
    
    // Name validation on blur - capitalize first letters
    callerNameInput.addEventListener('blur', function(e) {
        const value = e.target.value.trim();
        if (value) {
            e.target.value = value.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
            validateNameField(e.target);
        }
    });
    
    // Phone validation - only digits, max 9 digits
    callerPhoneInput.addEventListener('input', function(e) {
        let value = e.target.value;
        
        // Remove all non-digits
        value = value.replace(/[^0-9]/g, '');
        
        // Limit to 9 digits
        if (value.length > 9) {
            value = value.slice(0, 9);
        }
        
        e.target.value = value;
        validatePhoneField(e.target);
    });
    
    // Phone validation on paste
    callerPhoneInput.addEventListener('paste', function(e) {
        setTimeout(() => {
            let value = e.target.value;
            value = value.replace(/[^0-9]/g, '');
            if (value.length > 9) {
                value = value.slice(0, 9);
            }
            e.target.value = value;
            validatePhoneField(e.target);
        }, 10);
    });
    
    // Emergency type validation
    emergencyTypeSelect.addEventListener('change', function(e) {
        validateSelectField(e.target);
    });
    
    // Location address validation
    locationAddressInput.addEventListener('input', function(e) {
        validateLocationField(e.target);
    });
    
    locationAddressInput.addEventListener('blur', function(e) {
        const value = e.target.value.trim();
        if (value) {
            // Capitalize first letter of each word
            e.target.value = value.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
            validateLocationField(e.target);
        }
    });
    
    // Description validation
    descriptionTextarea.addEventListener('input', function(e) {
        validateDescriptionField(e.target);
    });
    
    // Prevent form submission on Enter key in input fields (except textarea)
    form.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.type !== 'submit') {
            e.preventDefault();
        }
    });
    
    // Enhanced validation functions
    function validateNameField(field) {
        const value = field.value.trim();
        const namePattern = /^[A-Za-z\s\-\']{2,50}$/;
        const hasValidLength = value.length >= 2 && value.length <= 50;
        const hasValidChars = namePattern.test(value);
        const hasNoConsecutiveSpaces = !/\s{2,}/.test(value);
        const isValid = hasValidLength && hasValidChars && hasNoConsecutiveSpaces;
        
        updateFieldValidation(field, isValid);
        
        // Update custom validation message
        if (!isValid && value.length > 0) {
            if (!hasValidLength) {
                field.setCustomValidity('Name must be between 2-50 characters');
            } else if (!hasValidChars) {
                field.setCustomValidity('Name can only contain letters, spaces, hyphens, and apostrophes');
            } else if (!hasNoConsecutiveSpaces) {
                field.setCustomValidity('No consecutive spaces allowed');
            }
        } else {
            field.setCustomValidity('');
        }
        
        return isValid;
    }
    
    function validatePhoneField(field) {
        const value = field.value.trim();
        const phonePattern = /^[0-9]{8,9}$/;
        const isValid = phonePattern.test(value);
        
        updateFieldValidation(field, isValid);
        
        // Update custom validation message
        if (!isValid && value.length > 0) {
            if (value.length < 8) {
                field.setCustomValidity('Phone number must be at least 8 digits');
            } else if (value.length > 9) {
                field.setCustomValidity('Phone number cannot exceed 9 digits');
            } else {
                field.setCustomValidity('Please enter a valid phone number');
            }
        } else {
            field.setCustomValidity('');
        }
        
        return isValid;
    }
    
    function validateSelectField(field) {
        const isValid = field.value !== '';
        updateFieldValidation(field, isValid);
        
        if (!isValid) {
            field.setCustomValidity('Please select an emergency type');
        } else {
            field.setCustomValidity('');
        }
        
        return isValid;
    }
    
    function validateLocationField(field) {
        const value = field.value.trim();
        const hasValidLength = value.length >= 5 && value.length <= 200;
        const hasValidChars = /^[A-Za-z0-9\s\-\,\.\#\/\(\)]+$/.test(value);
        const isValid = hasValidLength && hasValidChars;
        
        updateFieldValidation(field, isValid);
        
        if (!isValid && value.length > 0) {
            if (!hasValidLength) {
                field.setCustomValidity('Location must be between 5-200 characters');
            } else if (!hasValidChars) {
                field.setCustomValidity('Location contains invalid characters');
            }
        } else {
            field.setCustomValidity('');
        }
        
        return isValid;
    }
    
    function validateDescriptionField(field) {
        const value = field.value.trim();
        const hasValidLength = value.length >= 10 && value.length <= 1000;
        const wordCount = value.split(/\s+/).filter(word => word.length > 0).length;
        const hasMinWords = wordCount >= 3;
        const isValid = hasValidLength && hasMinWords;
        
        updateFieldValidation(field, isValid);
        
        // Update character count display
        const charCount = field.parentElement.querySelector('.char-count') || createCharCountDisplay(field);
        charCount.textContent = `${value.length}/1000 characters`;
        charCount.className = `char-count small ${value.length > 900 ? 'text-warning' : 'text-muted'}`;
        
        if (!isValid && value.length > 0) {
            if (!hasValidLength) {
                field.setCustomValidity('Description must be between 10-1000 characters');
            } else if (!hasMinWords) {
                field.setCustomValidity('Description must contain at least 3 words');
            }
        } else {
            field.setCustomValidity('');
        }
        
        return isValid;
    }
    
    function updateFieldValidation(field, isValid) {
        if (isValid) {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        } else {
            field.classList.remove('is-valid');
            if (field.value.trim().length > 0) {
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        }
    }
    
    function createCharCountDisplay(field) {
        const charCount = document.createElement('div');
        charCount.className = 'char-count small text-muted mt-1';
        field.parentElement.appendChild(charCount);
        return charCount;
    }
    
    // Real-time form validation check
    function isFormValid() {
        const nameValid = validateNameField(callerNameInput);
        const phoneValid = validatePhoneField(callerPhoneInput);
        const typeValid = validateSelectField(emergencyTypeSelect);
        const locationValid = validateLocationField(locationAddressInput);
        const descriptionValid = validateDescriptionField(descriptionTextarea);
        
        return nameValid && phoneValid && typeValid && locationValid && descriptionValid;
    }
    
    // GPS coordinate validation and rounding function
    function validateAndRoundCoordinates(lat, lng) {
        // Validate latitude (-90 to 90)
        if (lat < -90 || lat > 90) {
            throw new Error('Latitude must be between -90 and 90 degrees');
        }
        
        // Validate longitude (-180 to 180)
        if (lng < -180 || lng > 180) {
            throw new Error('Longitude must be between -180 and 180 degrees');
        }
        
        // Round to 6 decimal places for precision control
        return {
            latitude: Math.round(lat * 1000000) / 1000000,
            longitude: Math.round(lng * 1000000) / 1000000
        };
    }

    // Auto-fetch GPS location
    function getCurrentLocation() {
        if (!navigator.geolocation) {
            showToast('Geolocation is not supported by this browser.', 'error');
            return;
        }

        const btn = document.getElementById('getLocationBtn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
        btn.disabled = true;

        navigator.geolocation.getCurrentPosition(
            function(position) {
                try {
                    const coords = validateAndRoundCoordinates(
                        position.coords.latitude,
                        position.coords.longitude
                    );
                    
                    // Update coordinate fields
                    document.getElementById('latitude').value = coords.latitude;
                    document.getElementById('longitude').value = coords.longitude;
                    
                    // Validate the fields
                    validateCoordinateField(document.getElementById('latitude'));
                    validateCoordinateField(document.getElementById('longitude'));
                    
                    // Try to get address from coordinates
                    reverseGeocode(coords.latitude, coords.longitude);
                    
                    btn.innerHTML = '<i class="fas fa-check"></i> Location Found';
                    btn.classList.remove('btn-outline-classical');
                    btn.classList.add('btn-success');
                    
                    showToast('Location acquired successfully', 'success');
                    
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-crosshairs"></i> Auto-Locate';
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-classical');
                        btn.disabled = false;
                    }, 3000);
                } catch (error) {
                    console.error('Coordinate validation error:', error);
                    showToast(error.message, 'error');
                    resetLocationButton(btn);
                }
            },
            function(error) {
                console.error('Geolocation error:', error);
                let errorMessage = 'Unable to get your location. ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Please allow location access and try again.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Location information is unavailable.';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Location request timed out.';
                        break;
                    default:
                        errorMessage += 'An unknown error occurred.';
                        break;
                }
                
                showToast(errorMessage, 'warning');
                resetLocationButton(btn);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000
            }
        );
    }

    function resetLocationButton(btn) {
        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Location Failed';
        btn.classList.remove('btn-outline-classical');
        btn.classList.add('btn-warning');
        
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-crosshairs"></i> Auto-Locate';
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-outline-classical');
            btn.disabled = false;
        }, 3000);
    }

    // Coordinate field validation
    function validateCoordinateField(field) {
        const value = parseFloat(field.value);
        const fieldName = field.name;
        let isValid = true;
        let errorMessage = '';

        if (isNaN(value)) {
            isValid = false;
            errorMessage = `Please enter a valid ${fieldName}`;
        } else if (fieldName === 'latitude' && (value < -90 || value > 90)) {
            isValid = false;
            errorMessage = 'Latitude must be between -90 and 90 degrees';
        } else if (fieldName === 'longitude' && (value < -180 || value > 180)) {
            isValid = false;
            errorMessage = 'Longitude must be between -180 and 180 degrees';
        }

        if (isValid) {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
            // Round the value to 6 decimal places
            field.value = Math.round(value * 1000000) / 1000000;
        } else {
            field.classList.remove('is-valid');
            field.classList.add('is-invalid');
            field.nextElementSibling.textContent = errorMessage;
        }

        return isValid;
    }

    // Add coordinate validation listeners
    document.getElementById('latitude').addEventListener('input', function(e) {
        validateCoordinateField(e.target);
    });

    document.getElementById('longitude').addEventListener('input', function(e) {
        validateCoordinateField(e.target);
    });

    // Reverse geocoding function
    function reverseGeocode(lat, lng) {
        // Using OpenStreetMap Nominatim API for reverse geocoding
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    // Update the address field with the geocoded address
                    const addressField = document.getElementById('location_address');
                    addressField.value = data.display_name;
                    validateLocationField(addressField);
                    showToast('Address found from GPS coordinates', 'success');
                } else {
                    console.warn('No address found for coordinates');
                    showToast('GPS coordinates acquired, please enter address manually', 'info');
                }
            })
            .catch(error => {
                console.error('Reverse geocoding error:', error);
                showToast('GPS coordinates acquired, please enter address manually', 'info');
            });
    }

    // Get location button functionality
    getLocationBtn.addEventListener('click', getCurrentLocation);
    
    // Image upload functionality
    uploadArea.addEventListener('click', () => imageUpload.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--accent-red)';
        uploadArea.style.backgroundColor = 'var(--light-red)';
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--secondary-red)';
        uploadArea.style.backgroundColor = 'transparent';
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--secondary-red)';
        uploadArea.style.backgroundColor = 'transparent';
        
        const files = Array.from(e.dataTransfer.files);
        handleImageFiles(files);
    });
    
    imageUpload.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleImageFiles(files);
    });
    
    function handleImageFiles(files) {
        // Limit total number of images
        const maxImages = 5;
        const currentImageCount = uploadedImageUrls.length;
        
        if (currentImageCount >= maxImages) {
            showToast(`Maximum ${maxImages} images allowed.`, 'warning');
            return;
        }
        
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        const maxFileSize = 5 * 1024 * 1024; // 5MB
        
        Array.from(files).slice(0, maxImages - currentImageCount).forEach(file => {
            // Validate file type
            if (!allowedTypes.includes(file.type.toLowerCase())) {
                showToast(`Invalid file type: ${file.name}. Only JPEG, PNG, GIF, and WebP are allowed.`, 'error');
                return;
            }
            
            // Validate file size
            if (file.size > maxFileSize) {
                showToast(`File too large: ${file.name}. Maximum size is 5MB.`, 'error');
                return;
            }
            
            // Validate image dimensions (optional)
            validateImageDimensions(file).then(isValid => {
                if (isValid) {
                    uploadImage(file);
                } else {
                    showToast(`Image dimensions too large: ${file.name}. Maximum 4000x4000 pixels.`, 'error');
                }
            });
        });
    }
    
    function validateImageDimensions(file) {
        return new Promise((resolve) => {
            const img = new Image();
            const url = URL.createObjectURL(file);
            
            img.onload = function() {
                URL.revokeObjectURL(url);
                const maxDimension = 4000;
                resolve(this.width <= maxDimension && this.height <= maxDimension);
            };
            
            img.onerror = function() {
                URL.revokeObjectURL(url);
                resolve(false);
            };
            
            img.src = url;
        });
    }
    
    function uploadImage(file) {
        // Show upload progress
        const progressContainer = createUploadProgress(file.name);
        
        const formData = new FormData();
        formData.append('image', file);
        
        // Create XMLHttpRequest for progress tracking
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                updateUploadProgress(progressContainer, percentComplete);
            }
        });
        
        xhr.addEventListener('load', function() {
            try {
                const data = JSON.parse(xhr.responseText);
                if (xhr.status === 200 && data.success) {
                    uploadedImageUrls.push(data.image_url);
                    displayUploadedImage(data.image_url, file.name);
                    showToast(`Image uploaded: ${file.name}`, 'success');
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showToast(`Failed to upload ${file.name}: ${error.message}`, 'error');
            } finally {
                removeUploadProgress(progressContainer);
            }
        });
        
        xhr.addEventListener('error', function() {
            showToast(`Network error uploading ${file.name}`, 'error');
            removeUploadProgress(progressContainer);
        });
        
        xhr.open('POST', '/api/emergencies/upload-image/');
        xhr.setRequestHeader('X-CSRFToken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        xhr.send(formData);
    }
    
    function createUploadProgress(fileName) {
        const progressContainer = document.createElement('div');
        progressContainer.className = 'upload-progress-item mb-2';
        progressContainer.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-1">
                <small class="text-muted">${fileName}</small>
                <small class="progress-text">0%</small>
            </div>
            <div class="progress" style="height: 4px;">
                <div class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
            </div>
        `;
        uploadedImages.appendChild(progressContainer);
        return progressContainer;
    }
    
    function updateUploadProgress(container, percent) {
        const progressBar = container.querySelector('.progress-bar');
        const progressText = container.querySelector('.progress-text');
        progressBar.style.width = percent + '%';
        progressText.textContent = Math.round(percent) + '%';
    }
    
    function removeUploadProgress(container) {
        setTimeout(() => container.remove(), 1000);
    }
    
    function displayUploadedImage(imageUrl, fileName) {
        const imageContainer = document.createElement('div');
        imageContainer.className = 'd-inline-block me-2 mb-2 position-relative';
        imageContainer.innerHTML = `
            <img src="${imageUrl}" alt="${fileName}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
            <button type="button" class="btn btn-sm btn-danger position-absolute" style="top: -5px; right: -5px; border-radius: 50%; width: 20px; height: 20px; padding: 0; font-size: 10px;" onclick="removeImage('${imageUrl}', this)">
                <i class="fas fa-times"></i>
            </button>
        `;
        uploadedImages.appendChild(imageContainer);
    }
    
    window.removeImage = function(imageUrl, button) {
        uploadedImageUrls = uploadedImageUrls.filter(url => url !== imageUrl);
        button.parentElement.remove();
    };
    
    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Perform custom validation
        const formIsValid = isFormValid();
        
        if (form.checkValidity() && formIsValid) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Dispatching...';
            submitBtn.disabled = true;
            
            // Get form values
            const phoneNumber = document.getElementById('caller_phone').value;
            const fullPhoneNumber = phoneNumber.startsWith('+232') ? phoneNumber : 
                                 (phoneNumber.startsWith('0') ? '+232' + phoneNumber.substring(1) : '+232' + phoneNumber);
            
            // Create FormData to handle file uploads
            const formData = new FormData();
            formData.append('caller_name', document.getElementById('caller_name').value);
            formData.append('caller_phone', fullPhoneNumber);
            formData.append('emergency_type', document.getElementById('emergency_type').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('location_address', document.getElementById('location_address').value);
            formData.append('latitude', document.getElementById('latitude').value || '');
            formData.append('longitude', document.getElementById('longitude').value || '');
            
            // Add uploaded images to FormData
            const imageInput = document.getElementById('imageUpload');
            if (imageInput.files.length > 0) {
                for (let i = 0; i < imageInput.files.length; i++) {
                    formData.append('images', imageInput.files[i]);
                }
            }
            
            // Send the request
            fetch('/api/emergencies/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    // Don't set Content-Type when using FormData, let the browser set it with the correct boundary
                },
                body: formData
            })
            .then(async response => {
                const responseData = await response.json();
                if (!response.ok) {
                    return Promise.reject(responseData);
                }
                return responseData;
            })
            .then(data => {
                if (data.call_id) {
                    document.getElementById('callId').textContent = data.call_id;
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    form.reset();
                    form.classList.remove('was-validated');
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                let errorMessage = 'Failed to submit emergency request. Please try again or call 911 directly.';
                
                if (error.detail) {
                    errorMessage = error.detail;
                } else if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'object') {
                    // Handle validation errors from Django REST Framework
                    const errors = [];
                    for (const [field, messages] of Object.entries(error)) {
                        // Skip non_field_errors key to avoid duplicate messages
                        if (field === 'non_field_errors') {
                            errors.push(messages);
                            continue;
                        }
                        const fieldName = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        if (Array.isArray(messages)) {
                            errors.push(`${fieldName}: ${messages.join(', ')}`);
                        } else if (typeof messages === 'object') {
                            // Handle nested errors
                            for (const [nestedField, nestedMessages] of Object.entries(messages)) {
                                const nestedFieldName = nestedField.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                errors.push(`${fieldName} - ${nestedFieldName}: ${Array.isArray(nestedMessages) ? nestedMessages.join(', ') : nestedMessages}`);
                            }
                        } else {
                            errors.push(`${fieldName}: ${messages}`);
                        }
                    }
                    if (errors.length > 0) {
                        errorMessage = errors.join('; ');
                    }
                }
                
                showToast(errorMessage, 'error');
            })
            .finally(() => {
                submitBtn.innerHTML = '<i class="fas fa-ambulance me-3"></i>Dispatch Emergency Response';
                submitBtn.disabled = false;
            });
        }
        
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}